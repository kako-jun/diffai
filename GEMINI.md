# diffai: AI/MLデータ向け汎用差分ツール

## 思想（Philosophy）

**「あらゆるAI/MLデータ向けに、構造化された差分を、どこでも、簡単に。」**

`diffx` の核となる思想に基づき、`diffai` はAI（人工知能）およびML（機械学習）の複雑で多様なデータ形式における意味的な差分抽出の概念を拡張します。`diffx` が人間が読みやすい設定ファイルや構造化テキストに優れているのに対し、`diffai` は数値配列、テンソル、モデルパラメータ内の変更に対して、深く意味のある洞察を提供するよう設計されています。

AI/ML成果物の面倒でエラーが発生しやすい手動比較をなくし、データサイエンティスト、MLOpsエンジニア、研究者向けに明確で実用的な洞察を提供することを目指します。

### 名前「diffai」に込めた意味

*   **diff-**: 差分比較ツールであることを明確に示します。
*   **-ai**: AI（人工知能）分野に特化していることを示します。

`diffai` は、AI/MLデータの整合性と一貫性を検証するための頼れるソリューションとして、包括的な機能と究極の有用性を想起させます。

## 仕様（Specification）

### 対応フォーマット（初期段階）
- **NumPy (`.npy`, `.npz`)**: 数値配列。
- **PyTorch (`.pt`, `.pth`)**: テンソルおよびモデルの状態。
- **TensorFlow (`.tfrecord`, SavedModelコンポーネント)**: テンソルおよびグラフ定義。
- *将来的に：HDF5, Parquet, カスタムバイナリ形式など。

### 差分の種類
- **数値の変化**: 浮動小数点数の差分を、設定可能な許容誤差（絶対誤差および相対誤差）で検出します。
- **形状/次元の変化**: 配列/テンソルの次元の差分。
- **データ型（dtype）の変化**: 数値精度やデータ表現の差分。
- **構造の変化**: ディクショナリ（例：モデルの状態辞書）内のキーの追加/削除。
- **統計的差分**: （将来的に）大規模データセットの統計的特性（平均、分散、分布）の比較。
- **メタデータの変化**: 関連するメタデータの差分。
- **正規表現によるキーの無視**: 特定のパターンにマッチするキーを差分比較から除外する機能。

### 出力形式
- **CLI表示（デフォルト）**: 人間が読みやすい、色分けされた出力で、主要な差分、形状、dtype、数値の変化（例：`値1 -> 値2 (差分: X.Xe-Y)`）を強調表示します。
- **JSON/YAML**: プログラムによる分析およびMLOpsパイプラインへの統合のための機械可読な出力。
- **可視化**: （将来的に）数値差分を視覚化するためのプロットライブラリとの統合（例：配列差分のヒートマップ）。
- **diff互換形式 (Unified Format)**: `git` や既存のマージツールとの連携を目的とする。

### 主要機能
- **許容誤差ベースの比較**: 浮動小数点数に不可欠です。
- **再帰的比較**: AI/ML形式内のネストされたデータ構造を処理します。
- **パフォーマンス**: 大規模なデータセットとモデル向けに最適化されています。
- **拡張性**: 新しいデータ形式のサポートを容易に追加できるモジュラー設計。
- **ファイル拡張子からの自動判別**: 入力ファイルの拡張子を見て、自動的にフォーマットを決定する。
- **標準入力からの読み込み**: パイプ (`|`) を使って標準入力からデータを読み込めるようにする。
- **ディレクトリ比較**: 2つのディレクトリを比較し、その中の対応するファイルの差分を再帰的に検出する機能。

## アーキテクチャ（高レベル）

AI/MLのエコシステムを考慮すると、`diffai` は多言語アプローチを採用する可能性が高いです。

- **コアロジック（Rust）**: 高性能な数値比較とデータ解析。速度と安全性のためにはRustを主軸とする。
- **CLI（Rust）**: ユーザーインターフェース。
- **提供形態**: 
    - Rust Crate (`diffai-core`)
    - CLIツール (`diffai`)
    - 他言語向けラッパー（Python/Node.jsなど） - 将来的な拡張予定

## 将来的な展望
- MLOpsプラットフォーム（例：MLflow, DVC）との統合。
- データ差分をインタラクティブに可視化するためのWeb UI。
- プログラムによるアクセス用のAPI。
- AIエージェントとの連携（差分要約・説明）。

## このアプローチの理由
- 堅牢なデータバージョン管理と整合性チェックのためのAI/MLワークフローにおける重要なギャップを埋めます。
- 単純なファイルハッシュを超えた実用的な洞察を提供します。
- AI/MLモデルとデータセットのCI/CDにおける自動検証を可能にします。

## 段取り（Roadmap）

1.  **初期セットアップ**:
    *   プロジェクトの基本構造の作成 (`diffai-core/`, `diffai-cli/`, `examples/`, `docs/`, `tests/`)。
    *   Rustワークスペースのセットアップ。
    *   基本的なCLIエントリポイントの作成。
2.  **NumPy差分機能の実装**:
    *   `.npy`および`.npz`ファイルの読み込みと解析。
    *   数値、形状、dtypeの差分検出ロジックの実装。
    *   CLI出力の整形。
    *   許容誤差ベースの比較の実装。
3.  **PyTorch差分機能の実装**:
    *   `.pt`および`.pth`ファイルの読み込みと解析。
    *   テンソルおよびモデル状態の差分検出ロジックの実装。
    *   CLI出力の整形。
4.  **TensorFlow差分機能の実装**:
    *   `.tfrecord`およびSavedModelコンポーネントの読み込みと解析。
    *   テンソルおよびグラフ定義の差分検出ロジックの実装。
    *   CLI出力の整形。
5.  **出力形式の拡張**:
    *   JSON/YAML出力オプションの追加。
    *   diff互換形式 (Unified Format) の追加。
6.  **CLIのユーザビリティ向上**:
    *   ファイル拡張子からの自動判別。
    *   標準入力からの読み込み。
    *   ディレクトリ比較機能。
    *   正規表現によるキーの無視。
7.  **テストと最適化**:
    *   各機能に対する単体テストおよび統合テストの作成。
    *   大規模データセットに対するパフォーマンス最適化。
8.  **ドキュメントの作成**:
    *   使用方法、APIリファレンス、開発者ガイドの作成。
9.  **将来的な機能の検討**:
    *   統計的差分、可視化、MLOps統合、AIエージェント連携などの検討と計画。